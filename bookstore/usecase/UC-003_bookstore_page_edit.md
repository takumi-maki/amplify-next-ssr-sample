# ユースケース記述：書店ページ対象ライブラリ編集

## 1. ユースケースID
UC-003

## 2. ユースケース名
システム利用者が既存の書店ページ対象ライブラリ情報を編集する

## 3. 概要
システム利用者が既存の書店ページ対象ライブラリ情報を閲覧し、必要に応じて内容を編集・更新するプロセスを記述します。書店名、Library ID、HTMLファイルなどの項目を変更し、ビブリオンシステムに反映させます。

## 4. アクター
システム利用者（書店ページ管理者）

## 5. 事前条件
* システム利用者がビブリオンシステムにアクセス可能であること（IPアドレス制限による認証）。
* 編集対象の書店ページ対象ライブラリがAmplify Dataに登録済みであること。
* システムが正常に稼働しており、AWS Amplify Data、S3、Aurora MySQLへアクセス可能であること。

## 6. 事後条件
* **成功時:**
    * 編集された書店ページ対象ライブラリ情報がAmplify Dataに保存され、データベースが更新される。
    * Library IDが変更された場合、S3上のHTMLファイルが適切にリネーム（移動）される。
    * Aurora MySQLのshelf_items_folderテーブルが更新される。
    * HTMLファイルがアップロードまたは編集された場合、CloudFrontキャッシュが削除される。
    * 更新完了メッセージが表示され、一覧画面に遷移する。
* **失敗時:**
    * ライブラリ情報が更新されず、データベースに変更が加えられない。
    * エラーの内容に応じた適切なエラーメッセージが表示される。
    * ユーザーは入力内容を修正して再度更新を試みることができる。

## 7. トリガー
システム利用者が一覧画面で編集したいライブラリの行にある「編集」ボタンをクリックする。

## 8. 基本フロー（主成功シナリオ）
| No. | アクターのアクション                                                                 | システムのレスポンス                                                                                                                                                                                                                                                           |
| :-: | :----------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | ページ一覧または詳細画面から対象ページの「編集」ボタンをクリックする。                                                                   | システムは対象ページの現在の情報を取得し、編集フォームに表示する。フォームには以下の入力項目が含まれ、現在の値が初期表示される：<br>- ページ名<br>- URL識別子<br>- 説明文<br>- メタデータ（タイトル、説明、キーワードなど）<br>- 公開設定（公開/非公開）<br>- 公開期間<br>- その他の項目 |
| 2   | 基本情報（ページ名、説明文など）を必要に応じて編集する。 |                                                                                                                                                                                                                                                              |
| 3   | 「コンテンツ編集」タブまたはボタンをクリックする。                                                                      | システムはページエディタを表示する。エディタには、現在のページレイアウトとコンテンツが表示される。                                                                                                                                                                                            |
| 4   | ページエディタでコンテンツを編集する。テキスト修正、画像変更、コンポーネントの追加・削除・配置変更などを行う。                                                                      |                                                                                                                                                                                                                                                              |
| 5   | 「プレビュー」ボタンをクリックする（任意）。                                                                      | システムは編集されたページ情報に基づいて、実際の書店ページがどのように表示されるかのプレビューを生成し、表示する。                                                                                                                                                                                            |
| 6   | プレビューを確認し、必要に応じて入力内容を修正する。修正後、再度プレビューを確認することもできる。                                                                      |                                                                                                                                                                                                                                                              |
| 7   | すべての編集が完了したら、「更新」ボタンをクリックする。                                                                      | システムは編集されたデータのバリデーションを行う。入力内容に問題がなければ、ページ情報の更新をデータベースに保存する。この際、楽観的ロック制御のためのバージョン番号チェックも行われる。                                                                                                                                                                                            |
| 8   |                                                                                      | システムは更新完了メッセージを表示し、更新されたページの詳細画面またはページ一覧画面に遷移する。                                                                                                                                                                                            |

## 9. 代替フロー（例外シナリオ）
* **AF-001: 入力データのバリデーションエラー**
    * 基本フロー7において、編集されたデータにバリデーションエラーがある場合：
        1.  システムは更新処理を中断し、エラーメッセージを表示する。エラーメッセージは該当する入力フィールドの近くに表示され、具体的な問題点を示す。
        2.  ユーザーは入力内容を修正し、再度「更新」ボタンをクリックできる。（基本フロー7に戻る）

* **AF-002: URL識別子重複エラー**
    * 基本フロー7において、編集されたURL識別子が他の既存ページと重複している場合：
        1.  システムは更新処理を中断し、「このURL識別子は既に他のページで使用されています。別の識別子を指定してください。」というエラーメッセージを表示する。
        2.  ユーザーはURL識別子を修正し、再度「更新」ボタンをクリックできる。（基本フロー7に戻る）

* **AF-003: バージョン競合エラー（楽観的ロック）**
    * 基本フロー7において、編集中に他のユーザーが同じページを更新していた場合：
        1.  システムは更新処理を中断し、「このページは他のユーザーによって更新されています。最新の情報を取得してから再度編集してください。」というエラーメッセージを表示する。
        2.  ユーザーは「再読み込み」ボタンをクリックして最新のデータを取得するか、「編集を続行」ボタンをクリックして強制的に上書き保存を試みることができる（上位権限が必要な場合あり）。

* **AF-004: 画像アップロード**
    * 基本フロー4において、ユーザーが新しい画像をアップロードする場合：
        1.  ユーザーはエディタ内の既存画像を選択し、「画像変更」ボタンをクリックする。または、新しい画像コンポーネントを追加する。
        2.  システムは画像アップロードダイアログを表示する。
        3.  ユーザーはローカルファイルから画像を選択し、「アップロード」ボタンをクリックする。
        4.  システムは画像をサーバーにアップロードし、エディタ内の指定位置に表示する。
        5.  アップロードに失敗した場合（ファイルサイズ超過、不正なファイル形式など）、システムはエラーメッセージを表示し、ユーザーは別の画像を選択できる。

* **AF-005: システムエラー**
    * 基本フロー7において、データベース接続エラーなどのシステムエラーが発生した場合：
        1.  システムは更新処理を中断し、「システムエラーが発生しました。しばらく時間をおいてから再度お試しください。」というエラーメッセージを表示する。
        2.  ユーザーは再度「更新」ボタンをクリックして更新を試みるか、編集内容を一時的に保存（可能であれば）して後で再開することができる。

* **AF-006: 更新確認ダイアログ**
    * 基本フロー7において、「更新」ボタンクリック後の確認プロセス：
        1.  システムは「このページ情報を更新してよろしいですか？」という確認ダイアログを表示する。
        2.  ユーザーが「キャンセル」を選択した場合、更新処理は中断され、編集フォームに戻る。
        3.  ユーザーが「OK」を選択した場合、更新処理が続行される。（基本フロー7の続きへ）

* **AF-007: 下書き保存**
    * 基本フロー2～6のいずれかの段階で、ユーザーが「下書き保存」ボタンをクリックした場合：
        1.  システムは現在の編集内容を下書きとして保存する。
        2.  システムは「下書きとして保存しました。後で編集を再開できます。」というメッセージを表示する。
        3.  ユーザーは編集を続行するか、フォームを閉じることができる。

* **AF-008: 公開状態変更**
    * 基本フロー2において、ユーザーがページの公開状態を変更する場合：
        1.  ユーザーは公開設定を「公開」から「非公開」、または「非公開」から「公開」に変更する。
        2.  公開から非公開への変更の場合、システムは「このページを非公開にすると、ユーザーからアクセスできなくなります。よろしいですか？」という確認メッセージを表示する。
        3.  非公開から公開への変更の場合、システムは公開開始日時の設定オプションを表示する。

* **AF-009: 変更履歴の表示**
    * 基本フロー1の後、ユーザーが「変更履歴」ボタンをクリックした場合：
        1.  システムはこのページの過去の変更履歴を一覧表示する。
        2.  ユーザーは特定のバージョンを選択して、そのバージョンの内容を表示したり、現在の編集内容と比較したりできる。
        3.  必要に応じて、ユーザーは特定のバージョンに戻す操作を行うことができる。

## 10. 備考・補足事項
* **入力項目のバリデーションルール:**
    * ページ名：1～100文字
    * URL識別子：英数字とハイフンのみ、3～50文字、一意であること（ただし、現在のページと同じ識別子は許可）
    * 説明文：1～2000文字
    * 公開期間：開始日時は現在日時以降、終了日時は開始日時より後であること
* **エディタの機能:**
    * ドラッグ＆ドロップによるコンポーネントの配置
    * リッチテキストエディタによるテキスト編集
    * 画像のアップロードとサイズ調整
    * レスポンシブデザインのプレビュー（PC、タブレット、スマートフォン）
* **プレビュー機能:**
    * プレビューでは実際のページレイアウトを確認できる
    * プレビューはPCとモバイルの両方のレイアウトを確認できることが望ましい
* **バージョン管理:**
    * 楽観的ロック制御のため、各ページにはバージョン番号が付与される
    * 編集開始時のバージョンと更新時のバージョンが一致しない場合は競合エラーとなる
    * 変更履歴として過去のバージョンを参照可能にすることが望ましい
* **権限制御:**
    * ページ編集には専用の権限が必要
    * 一部の高度な設定項目は上位権限を持つユーザーのみ編集可能
* **公開制御:**
    * 公開状態の変更（公開⇔非公開）は即時反映または指定日時に自動反映
    * 公開期間の設定により、指定期間のみ公開状態となる自動制御が可能
* **その他の考慮事項:**
    * 複数ユーザーによる同時編集の競合制御
    * ページ情報の変更履歴管理
    * SEO対策のためのメタデータ設定
    * ソーシャルメディア共有時のOGP設定
