# ユースケース記述：書店ページ対象ライブラリ登録

## 1. ユースケースID
UC-002

## 2. ユースケース名
システム利用者が新規書店ページ対象ライブラリを登録する

## 3. 概要
システム利用者が新しい書店ページ対象ライブラリの情報を入力し、ビブリオンシステムに登録するプロセスを記述します。書店名、Library ID、HTMLファイルの必要事項を入力し、登録を完了させます。

## 4. アクター
システム利用者（書店ページ管理者）

## 5. 事前条件
* システム利用者がシステムにアクセス可能であること。
* システムが正常に稼働していること。
* 必要なデータストレージが利用可能であること。

## 6. 事後条件
* **成功時:**
    * 新しい書店ページ対象ライブラリがシステムに登録され、一意のIDが割り当てられる。
    * HTMLファイルが選択されている場合、適切な場所にアップロードされる。
    * 関連するデータベースが更新される。
    * キャッシュが適切に更新される（HTMLファイルがアップロードされた場合）。
    * 登録完了メッセージが表示され、一覧画面に遷移する。
* **失敗時:**
    * ライブラリ情報が登録されず、データベースに変更が加えられない。
    * エラーの内容に応じた適切なエラーメッセージが表示される（バリデーションエラー、重複エラー、システムエラーなど）。
    * ユーザーは入力内容を修正して再度登録を試みることができる。

## 7. トリガー
システム利用者が一覧画面の「新規登録」ボタンをクリックする。

## 8. 基本フロー（主成功シナリオ）
| No. | アクターのアクション                                                                 | システムのレスポンス                                                                                                                                                                                                                                                           |
| :-: | :----------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | 「新規登録」ボタンをクリックする。                                                                   | システムは新規登録フォームを表示する。フォームには以下の入力項目が含まれる：<br>- 書店名（必須）<br>- Library ID（必須）<br>- HTMLファイル（任意） |
| 2   | 書店名とLibrary IDを入力する。 |                                                                                                                                                                                                                                                              |
| 3   | 必要に応じてHTMLファイルを選択する（任意）。                                                                      | システムは選択されたHTMLファイルのプレビューを表示する。                                                                                                                                                                                            |
| 4   | 「登録」ボタンをクリックする。                                                                      | システムは入力されたデータのバリデーションを行う。入力内容に問題がなければ、新しいライブラリ情報をシステムに保存する。                                                                                                                                                                                            |
| 5   |                                                                                      | システムは登録完了メッセージを表示し、一覧画面に遷移する。                                                                                                                                                                                            |

## 9. 代替フロー（例外シナリオ）
* **AF-001: 入力データのバリデーションエラー**
    * 基本フロー4において、入力されたデータにバリデーションエラーがある場合：
        1.  システムは登録処理を中断し、エラーメッセージを表示する。エラーメッセージは該当する入力フィールドの近くに表示され、具体的な問題点（例：「書店名は必須です」「Library IDに使用できない文字が含まれています」）を示す。
        2.  ユーザーは入力内容を修正し、再度「登録」ボタンをクリックできる。（基本フロー4に戻る）

* **AF-002: Library ID重複エラー**
    * 基本フロー4において、入力されたLibrary IDが既存のライブラリと重複している場合：
        1.  システムは登録処理を中断し、「このLibrary IDは既に使用されています。別のIDを指定してください。」というエラーメッセージを表示する。
        2.  ユーザーはLibrary IDを修正し、再度「登録」ボタンをクリックできる。（基本フロー4に戻る）

* **AF-003: HTMLファイルアップロードエラー**
    * 基本フロー3において、HTMLファイルのアップロードに失敗した場合：
        1.  システムはエラーメッセージを表示する（例：「ファイルサイズが大きすぎます」「対応していないファイル形式です」）。
        2.  ユーザーは別のファイルを選択するか、ファイルなしで登録を続行できる。

* **AF-004: システムエラー**
    * 基本フロー4において、システムエラーが発生した場合：
        1.  システムは登録処理を中断し、「システムエラーが発生しました。しばらく時間をおいてから再度お試しください。」というエラーメッセージを表示する。
        2.  ユーザーは再度「登録」ボタンをクリックして登録を試みることができる。

* **AF-005: 登録確認ダイアログ**
    * 基本フロー4において、「登録」ボタンクリック後の確認プロセス：
        1.  システムは「このライブラリ情報を登録してよろしいですか？」という確認ダイアログを表示する。
        2.  ユーザーが「キャンセル」を選択した場合、登録処理は中断され、入力フォームに戻る。
        3.  ユーザーが「OK」を選択した場合、登録処理が続行される。（基本フロー4の続きへ）

## 10. 備考・補足事項
* **入力項目のバリデーションルール:**
    * 書店名：1～100文字、必須
    * Library ID：英数字のみ、15桁、一意であること、必須
    * HTMLファイル：HTML形式、任意
* **プレビュー機能:**
    * HTMLファイルが選択された場合、プレビューで内容を確認できる
* **権限制御:**
    * システム利用者は全員同じ権限を持つ
* **登録後の処理:**
    * 登録完了後は一覧画面に遷移する
    * 登録されたライブラリは即座に一覧に反映される
* **技術実装:** AWS Amplify Gen 2を使用したフルスタック開発、IPアドレス制限による認証、Amplify Data (GraphQL API) をメインデータストアとして使用、既存S3バケット `valuebooks-producton-mainsite-cdn` を使用、Aurora MySQL `shelf_items_folder` テーブルとの連携、CloudFront キャッシュの削除機能
