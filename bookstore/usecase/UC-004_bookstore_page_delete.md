# ユースケース記述：書店ページ対象ライブラリ削除

## 1. ユースケースID
UC-004

## 2. ユースケース名
システム利用者が既存の書店ページ対象ライブラリを削除する

## 3. 概要
システム利用者が不要になった書店ページ対象ライブラリをビブリオンシステムから削除するプロセスを記述します。削除前の確認、関連データの削除、および削除後の処理を含みます。

## 4. アクター
システム利用者（書店ページ管理者）

## 5. 事前条件
* システム利用者がビブリオンシステムにアクセス可能であること（IPアドレス制限による認証）。
* 削除対象の書店ページ対象ライブラリがAmplify Dataに登録済みであること。
* システムが正常に稼働しており、AWS Amplify Data、S3、Aurora MySQLへアクセス可能であること。

## 6. 事後条件
* **成功時:**
    * 対象の書店ページ対象ライブラリがAmplify Dataから削除される。
    * S3上の関連HTMLファイル（ws/library/{library_id}.html）が削除される。
    * Aurora MySQLのshelf_items_folderテーブルのexternal_html_urlがnullに更新される。
    * 削除完了メッセージが表示され、一覧画面が再読み込みされる。
* **失敗時:**
    * ライブラリ情報が削除されず、データベースに変更が加えられない。
    * エラーの内容に応じた適切なエラーメッセージが表示される。
    * ユーザーは別の操作を選択するか、エラーの原因を解消して再度削除を試みることができる。

## 7. トリガー
システム利用者が一覧画面で削除したいライブラリの行にある「削除」ボタンをクリックする。

## 8. 基本フロー（主成功シナリオ）
| No. | アクターのアクション                                                                 | システムのレスポンス                                                                                                                                                                                                                                                           |
| :-: | :----------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | ページ一覧または詳細画面から対象ページの「削除」ボタンをクリックする。                                                                   | システムは削除確認ダイアログを表示する。ダイアログには以下の情報が含まれる：<br>- 削除対象ページの名称<br>- 削除の影響に関する注意事項<br>- 「キャンセル」ボタンと「削除」ボタン |
| 2   | 削除確認ダイアログで「削除」ボタンをクリックする。 | システムは対象ページに関連するデータ（アクセス統計、参照リンクなど）があるかチェックする。                                                                                                                                                                                                                                                              |
| 3   |                                                                                      | 関連するデータがあっても削除可能な場合、システムは対象ページを論理削除する（削除フラグを立て、削除日時を記録する）。                                                                                                                                                                                            |
| 4   |                                                                                      | システムは削除完了メッセージを表示し、ページ一覧画面に遷移する。一覧からは削除されたページが除外されている。                                                                                                                                                                                            |

## 9. 代替フロー（例外シナリオ）
* **AF-001: 削除確認でキャンセル**
    * 基本フロー2において、ユーザーが削除確認ダイアログで「キャンセル」ボタンをクリックした場合：
        1.  システムは削除処理を中断し、削除確認ダイアログを閉じる。
        2.  ユーザーは元の画面（ページ一覧または詳細画面）に戻る。

* **AF-002: 重要なページの削除**
    * 基本フロー2の後、対象ページが重要なページ（例：トップページ、必須ページなど）としてマークされている場合：
        1.  システムは削除処理を中断し、「このページは重要なページとして設定されているため削除できません。別のページを削除するか、管理者に連絡してください。」というエラーメッセージを表示する。
        2.  ユーザーは「OK」ボタンをクリックしてメッセージを閉じ、元の画面に戻る。

* **AF-003: 権限不足**
    * 基本フロー1において、ユーザーがページ削除の権限を持っていない場合：
        1.  システムは「このページを削除する権限がありません。管理者にお問い合わせください。」というエラーメッセージを表示する。
        2.  ユーザーは「OK」ボタンをクリックしてメッセージを閉じ、元の画面に戻る。

* **AF-004: システムエラー**
    * 基本フロー3において、データベース接続エラーなどのシステムエラーが発生した場合：
        1.  システムは削除処理を中断し、「システムエラーが発生しました。しばらく時間をおいてから再度お試しください。」というエラーメッセージを表示する。
        2.  ユーザーは「OK」ボタンをクリックしてメッセージを閉じ、元の画面に戻る。

* **AF-005: 強制削除（管理者権限）**
    * 基本フロー2の後、重要なページとしてマークされているが、管理者権限を持つユーザーが強制削除を選択する場合：
        1.  システムは「このページは重要なページとしてマークされていますが、強制的に削除しますか？」という警告メッセージと「キャンセル」「強制削除」ボタンを表示する。
        2.  ユーザーが「強制削除」を選択した場合、システムは対象ページを論理削除し、削除完了メッセージを表示する。
        3.  ユーザーが「キャンセル」を選択した場合、削除処理は中断され、元の画面に戻る。

* **AF-006: 物理削除（管理者権限）**
    * 基本フロー1において、管理者権限を持つユーザーが「物理削除」オプションを選択する場合：
        1.  ユーザーはページ一覧または詳細画面から対象ページの「物理削除」ボタンをクリックする。
        2.  システムは「このページをデータベースから完全に削除します。この操作は元に戻せません。続行しますか？」という警告メッセージと「キャンセル」「物理削除」ボタンを表示する。
        3.  ユーザーが「物理削除」を選択した場合、システムは対象ページをデータベースから完全に削除し、削除完了メッセージを表示する。
        4.  ユーザーが「キャンセル」を選択した場合、削除処理は中断され、元の画面に戻る。

## 10. 備考・補足事項
* **論理削除と物理削除:**
    * 標準的な削除操作は論理削除（削除フラグを立てる）として実装
    * 物理削除（データベースからの完全削除）は管理者向けの別機能として実装することが望ましい
* **削除の制限:**
    * 重要なページ（トップページなど）は削除不可または特別な権限が必要
    * 他のページから参照されているページを削除する場合は警告表示
* **削除後のデータ参照:**
    * 論理削除されたページは通常の一覧には表示されないが、管理者向けの「削除済みページ一覧」などで参照可能にすることが望ましい
    * 削除から一定期間内であれば、管理者による復元機能を提供することも検討
* **監査ログ:**
    * ページ削除操作は重要な操作のため、誰がいつ削除したかを監査ログに記録する
    * 物理削除の場合は特に詳細なログを残す
* **関連データの扱い:**
    * ページに関連するアクセス統計データは削除せず、参照可能な状態を維持
    * 削除されたページへのリンクは「ページが見つかりません」ページにリダイレクト
* **権限制御:**
    * ページ削除には専用の権限が必要
    * 物理削除や強制削除には上位の管理者権限が必要
* **削除の代替手段:**
    * 削除の代わりに「非公開」状態に変更する機能を提供することも検討
