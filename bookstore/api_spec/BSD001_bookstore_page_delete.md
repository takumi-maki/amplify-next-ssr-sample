## API設計(GraphQL API)

### 1. エンドポイント: 書店ページ対象ライブラリ削除

#### GraphQL Mutation定義

```graphql
mutation DeleteBookstoreLibrary($input: DeleteBookstoreLibraryInput!) {
  deleteBookstoreLibrary(input: $input) {
    id
    storeName
    libraryId
    htmlFileUrl
    createdAt
    updatedAt
  }
}
```

#### 入力型定義

```graphql
input DeleteBookstoreLibraryInput {
  id: ID!
}
```

#### リクエスト変数

| フィールド | 型 | 必須 | 説明 |
|------------|----|----|------|
| id | ID | ○ | 書店ページ対象ライブラリの一意識別子 |

#### リクエスト例

```
```javascript
const response = await deleteBookstorePage('bp-12345', 6);
```
```

#### レスポンス定義

| フィールド | 型 | 説明 |
|-----------|----|----|
| success | Boolean | 削除成功フラグ（常にtrue） |
| deletedAt | ISO8601日時 | 削除日時 |
| message | String | 成功メッセージ |

#### レスポンス例 (JSON)

```json
{
  "success": true,
  "deletedAt": "2025-05-14T11:00:00Z",
  "message": "書店ページが正常に削除されました"
}
```

### 2. エラーレスポンス定義

#### エラーレスポンス構造

| フィールド | 型 | 説明 |
|-----------|----|----|
| error | Object | エラー情報 |
| error.code | String | エラーコード |
| error.message | String | エラーメッセージ |
| error.details | Array/Object | エラー詳細情報（オプション） |

#### ステータスコードとエラーコード

| HTTPステータスコード | エラーコード | エラー内容 | メッセージ例 |
|--------------------|------------|-----------|------------|
| 400 | INVALID_REQUEST | リクエスト形式不正 | リクエスト形式が不正です。 |
| 400 | MISSING_VERSION | バージョン番号未指定 | バージョン番号を指定してください。 |
| 401 | UNAUTHORIZED | 認証エラー | 認証されていません。 |
| 403 | FORBIDDEN | アクセス権限エラー | この操作を行う権限がありません。 |
| 403 | STATUS_CONSTRAINT | ステータス制約違反 | 公開中の書店ページは削除できません。まず非公開に設定してください。 |
| 404 | RESOURCE_NOT_FOUND | リソース未発見 | 指定された書店ページが見つかりません。 |
| 409 | VERSION_CONFLICT | バージョン競合 | データが他のユーザーによって更新されています。 |
| 409 | RELATED_DATA_EXISTS | 関連データ存在 | この書店ページには関連する処理中データが存在するため削除できません。 |
| 500 | INTERNAL_SERVER_ERROR | サーバー内部エラー | システムエラーが発生しました。 |
| 503 | SERVICE_UNAVAILABLE | サービス一時停止 | 現在サービスをご利用いただけません。 |

#### エラーレスポンス例 (JSON)

```json
{
  "error": {
    "code": "STATUS_CONSTRAINT",
    "message": "公開中（published状態）の書店ページは削除できません。まずdraftに設定してください。"
  }
}
```

#### バージョン競合エラーレスポンス例 (JSON)

```json
{
  "error": {
    "code": "VERSION_CONFLICT",
    "message": "データが他のユーザーによって更新されています。最新のデータを取得してから再度操作してください。",
    "details": {
      "currentVersion": 8,
      "requestedVersion": 7
    }
  }
}
```

#### 関連データ存在エラーレスポンス例 (JSON)

```json
{
  "error": {
    "code": "RELATED_DATA_EXISTS",
    "message": "この書店ページには関連する処理中データが存在するため削除できません。",
    "details": {
      "relatedDataTypes": ["pendingOrders", "activePromotions"]
    }
  }
}
```

### 3. セキュリティ・認証仕様

| 項目 | 内容 |
|------|------|
| 認証方式 | AWS_IAM または Cognito User Pools |
| 必要権限 | Cognitoユーザープールにおける削除権限 |
| アクセス制御 | RBAC（ロールベースアクセス制御） |
| レート制限 | API Gateway設定に基づく |
| CORS対応 | API Gateway CORS設定 |
| 監査ログ | Lambda関数内での全ての削除操作のログ記録 |

### 4. ビジネスルール

| ルール | 説明 | 実装方法 |
|-------|------|---------|
| 公開ページ削除禁止 | 公開状態（published）の書店ページは直接削除できない | ステータスチェックで拒否（STATUS_CONSTRAINT） |
| 処理中データ関連禁止 | 処理中の注文やプロモーションに関連付けられた書店ページは削除禁止 | 関連データチェックで拒否（RELATED_DATA_EXISTS） |
| 論理削除/物理削除 | 標準は論理削除を適用し、データベースには削除フラグと削除日時を記録 | deletedフラグとdeletedAt日時をセット |
| 関連リソース処理 | 書店ページに関連する店舗画像ファイルも適切に処理（アーカイブ） | 非同期ジョブで処理 |
| 削除権限制限 | 書店ページの削除は高い権限レベルを要求（一般書店員には制限） | RBAC権限スコープで制御 |

### 5. 監査ログ仕様

| 記録項目 | 内容 | 保存期間 | 備考 |
|---------|------|---------|------|
| リクエストID | 一意のリクエスト識別子 | 365日 | トラブルシュート用 |
| タイムスタンプ | リクエスト受信日時 | 365日 | ISO8601形式 |
| ユーザー識別情報 | ユーザーID、IPアドレス | 365日 | 監査証跡 |
| 対象リソース | 書店ページID、書店名 | 365日 | 何が削除されたか |
| ステータス情報 | 削除前の公開状態 | 365日 | 削除前の状態記録 |
| 関連メタデータ | 作成日、最終更新日、タグ情報など | 365日 | 復元時の参照用 |
| 結果情報 | 成功/失敗、エラーコード | 365日 | 操作結果記録 |

### 6. 処理フロー

1. **認証・認可検証**:
   - JWTトークンの検証
   - 削除権限の確認

2. **前提条件検証**:
   - リソース存在確認
   - バージョン番号検証
   - ステータス検証（公開中でないこと）
   - 関連データ存在チェック

3. **削除処理実行**:
   - 書店ページレコードに削除フラグ設定
   - 削除日時記録
   - 関連リソースの非同期処理キュー登録

4. **後処理**:
   - 監査ログ記録
   - 正常レスポンス生成
   - キャッシュ更新/無効化

### 7. エラーハンドリング方針

| エラーシナリオ | 処理方針 | 利用者向け対応 |
|---------------|---------|--------------|
| 存在しないリソース | 404エラー返却 | 一覧画面への誘導 |
| 公開中ページ削除試行 | 403エラー返却 | 非公開設定への誘導 |
| 関連データ存在 | 409エラー返却 | 関連データ解消方法の案内 |
| 権限不足 | 403エラー返却 | 適切な権限者への依頼案内 |
| サーバーエラー | 500エラー返却 | 時間をおいての再試行案内 |

### 8. パフォーマンス考慮事項

| 項目 | 設計方針 | 備考 |
|------|---------|------|
| タイムアウト設定 | 削除API呼び出し：API Gatewayの設定に基づく | Lambdaのタイムアウトは30秒以下を推奨 |
| 非同期処理 | DynamoDB StreamsとLambdaの組み合わせ | メインのDB操作完了後に応答返却 |
| キャッシュ無効化 | CloudFrontとAPI Gatewayキャッシュの即時無効化 | 削除後の404エラー回避 |
| データベース負荷 | DynamoDBのトランザクション処理 | 関連テーブルの一貫性維持 |
| リトライ機構 | AWS Lambdaのリトライ機能を活用 | Step Functionsによるリトライ制御 |
